#!/bin/bash

echo "üöÄ –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ —Å–±–æ—Ä–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤ CF"
echo "============================================"

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞
cd ~/Pictures/Puppeteer || exit

# --- –≠–¢–ê–ü 0: –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø (–°–ê–ú–û–ï –í–ê–ñ–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï) ---
# –î–µ–ª–∞–µ–º pull –î–û —Ç–æ–≥–æ, –∫–∞–∫ –Ω–∞—á–Ω–µ–º –º–µ–Ω—è—Ç—å —Ñ–∞–π–ª—ã, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –æ—à–∏–±–∫–∏ "unstaged changes"
echo ""
echo "üîÑ –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å GitHub..."
if [ -d "screenshots" ]; then
  cd screenshots
  # –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è - —Å–ø—Ä—è—á–µ–º –∏—Ö, –æ–±–Ω–æ–≤–∏–º—Å—è –∏ –≤–µ—Ä–Ω–µ–º
  git stash
  git pull --rebase origin main
  git stash pop 2>/dev/null # –í–µ—Ä–Ω–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏ (–æ—à–∏–±–∫–∏ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º)
  cd ..
fi

# --- –≠–¢–ê–ü 1: –û–ß–ò–°–¢–ö–ê ---
# –£–¥–∞–ª—è–µ–º –¢–û–õ–¨–ö–û —Å—Ç–∞—Ä—ã–µ CF-—Å–∫—Ä–∏–Ω—à–æ—Ç—ã (–Ω–µ —Ç—Ä–æ–≥–∞–µ–º TV-—Ñ–∞–π–ª—ã)
echo ""
echo "üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö CF-—Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤ (cf_*.png)..."
rm -f screenshots/cf_*.png

# --- –≠–¢–ê–ü 2: –ì–ï–ù–ï–†–ê–¶–ò–Ø ---
echo ""
echo "üì∏ –ó–∞–ø—É—Å–∫ —Å–±–æ—Ä–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤..."
node capture_cf.mjs

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç—Ä–∞–±–æ—Ç–∞–ª –ª–∏ Node.js —É—Å–ø–µ—à–Ω–æ
if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –≤ JS —Å–∫—Ä–∏–ø—Ç–µ!"
    exit 1
fi

# –î–æ–±–∞–≤–ª—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π timestamp –¢–û–õ–¨–ö–û –≤ CF-—Ñ–∞–π–ª—ã
echo ""
echo "üîß –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö CF-—Ñ–∞–π–ª–æ–≤..."
for file in screenshots/cf_*.png; do
  # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é
  [ -f "$file" ] && echo "$(date +%s%N)" >> "$file"
done

# --- –≠–¢–ê–ü 3: –ü–†–û–í–ï–†–ö–ê ---
# –°—á–∏—Ç–∞–µ–º –∫–æ–ª-–≤–æ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö CF —Ñ–∞–π–ª–æ–≤
SCREENSHOT_COUNT=$(ls -1 screenshots/cf_*.png 2>/dev/null | wc -l | xargs)

if [ "$SCREENSHOT_COUNT" -eq "0" ]; then
  echo ""
  echo "‚ùå –û—à–∏–±–∫–∞: CF-—Å–∫—Ä–∏–Ω—à–æ—Ç—ã –Ω–µ —Å–æ–∑–¥–∞–Ω—ã"
  exit 1
fi

echo "‚úì –°–æ–∑–¥–∞–Ω–æ CF-—Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤: $SCREENSHOT_COUNT"

# --- –≠–¢–ê–ü 4: –û–¢–ü–†–ê–í–ö–ê ---
echo ""
echo "üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –≤ GitHub..."
cd screenshots || exit

# –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –Ω–æ–≤—ã–µ PNG
git add *.png

# –ö–æ–º–º–∏—Ç–∏–º
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
if git commit -m "Update CF screenshots - $TIMESTAMP" --quiet; then
  
  # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –æ–±–Ω–æ–≤–∏—Ç—å—Å—è (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –∫—Ç–æ-—Ç–æ —É—Å–ø–µ–ª –∑–∞–ø—É—à–∏—Ç—å –∑–∞ —ç—Ç–∏ 30 —Å–µ–∫)
  git pull --rebase origin main
  
  if git push origin main; then
    echo ""
    echo "‚úÖ –í—Å–µ CF-—Å–∫—Ä–∏–Ω—à–æ—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ GitHub!"
  else
    echo ""
    echo "‚ö†Ô∏è –û—à–∏–±–∫–∞ git push"
  fi
else
  echo ""
  echo "‚ö†Ô∏è –ù–µ—Ç –Ω–æ–≤—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏"
fi

echo "üîó https://github.com/llsarbell/screenshots"

cd ..
echo ""
echo "‚úÖ –ì–û–¢–û–í–û! –í—Å–µ —Å–∫—Ä–∏–Ω—à–æ—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã"
echo "============================================"
